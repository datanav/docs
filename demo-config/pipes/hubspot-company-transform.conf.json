{
  "_id": "hubspot-company-transform",
  "type": "pipe",
  "source": {
    "type": "dataset",
    "completeness": false,
    "dataset": "global-organisation",
    "include_replaced": false,
    "subset": ["eq",
      ["is-not-empty", "_S.global-organisation:domain"], true]
  },
  "transform": {
    "type": "dtl",
    "rules": {
      "default": [
        ["comment", "*** Filter data ***"],
        ["add", "_x",
          ["apply-hops", "broader", {
            "datasets": ["global-classification t"],
            "where": [
              ["eq", "_S.global-organisation:classification", "t.$ids"]
            ]
          }]
        ],
        ["filter",
          ["and",
            ["is-not-empty",
              ["intersection",
                ["list", "~:dbr:Information_technology", "~:nace-2008:62", "~:nace-2008:63"], "_T._x.$ids"]
            ]
          ]
        ],
        ["comment", "*** Add hubspot properties ***"],
        ["add", "_id",
          ["replace", ":", "-", "_S._id"]
        ],
        ["add", "id",
          ["first", "_S.hubspot-company:id"]
        ],
        ["add", "sesam-id", "_S._id"],
        ["add", "properties",
          ["apply", "properties", "_S."]
        ],
        ["comment", "*** Add optimistic locking property ***"],
        ["add", "$hash",
          ["hash128", "murmur3",
            ["json-transit",
              ["first",
                ["apply-hops", "raw-entity-for-hash", {
                  "datasets": ["hubspot-company-collect hcc"],
                  "where": [
                    ["eq", "_S.hubspot-company:id", "hcc.id"]
                  ]
                }]
              ]
            ]
          ]
        ]
      ],
      "broader": [
        ["comment", "*** Recurcive data ***"],
        ["merge-union",
          ["hops", {
            "datasets": ["global-classification t"],
            "where": [
              ["eq", "_S.skos:broader", "t.$ids"]
            ],
            "recurse": true,
            "max_depth": 5
          }]
        ]
      ],
      "properties": [
        ["add", "name", "_S.global-organisation:name"],
        ["add", "website", "_S.global-organisation:domain"],
        ["add", "about_us",
          ["first", "_S.global-organisation:company-id"]
        ]
      ],
      "raw-entity-for-hash": [
        ["copy", "*", "_*"]
      ]
    }
  },
  "remove_namespaces": true
}
